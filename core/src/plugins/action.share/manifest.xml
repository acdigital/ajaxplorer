<?xml version="1.0" encoding="UTF-8"?>
<action_plugin name="share" label="Sharing Features" description="Share Center actions and hooks">
    <server_settings>
        <global_param name="METADATA_FILE" type="string" label="Metadata FIle" description="Hidden file containing shared metadata" mandatory="true" default=".ajxp_share_meta"/>
    </server_settings>
    <registry_contributions>
        <hooks>
            <serverCallback hookName="node.info" methodName="nodeSharedMetadata"></serverCallback>
            <serverCallback hookName="node.change" methodName="updateNodeSharedData"></serverCallback>
        </hooks>
        <actions>
            <action name="share">
                <gui text="292" title="292" src="share.png" hasAccessKey="false">
                    <context selection="true" dir="" recycle="hidden"
                        actionBar="true" contextMenu="true" infoPanel="true"
                        actionBarGroup="put">
                    </context>
                    <selectionContext dir="true" file="true" recycle="false" unique="true"></selectionContext></gui>
                <rightsContext noUser="true" userLogged="only" read="true" write="true" adminOnly=""></rightsContext>
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
                        var userSelection = ajaxplorer.getUserSelection();
                        if(userSelection.hasDir() && !userSelection.hasMime($A(['ajxp_browsable_archive']))){
                            var loadFunc = function(oForm){
                                new Protopass($('shared_pass'), {
                                    barContainer : $('pass_strength_container'),
                                    barPosition:'bottom'
                                });
                                oForm.down('#repo_label').setValue(getBaseName(userSelection.getUniqueNode().getPath()));
                                if(!$('share_folder_form').autocompleter){
                                    $('share_folder_form').autocompleter = new Ajax.Autocompleter(
                                        "shared_user",
                                        "shared_users_autocomplete_choices",
                                        ajxpServerAccessPath + "&get_action=share&sub_action=list_shared_users",
                                        {minChars:0, paramName:'value'}
                                    );
                                    $('shared_user').observeOnce("focus", function(){
                                        $('share_folder_form').autocompleter.activate();
                                    });
                                    $('shared_user').observe("blur", function(){
                                        var existing = $('shared_users_autocomplete_choices').select('li').detect(function(li){
                                            return (li.innerHTML == $('shared_user').getValue());
                                        });
                                        if(existing) {
                                            $('shared_pass_div').addClassName('SF_disabled');
                                            $('shared_pass').disable();
                                        }else {
                                            $('shared_pass_div').removeClassName('SF_disabled');
                                            $('shared_pass').enable();
                                        }
                                    });
                                }
                            };
                            var submitFunc = function(oForm){
                                if(!$('shared_pass').disabled){
                                    if( !$('shared_pass').value || $('shared_pass').value.length < ajxpBootstrap.parameters.get('password_min_length')){
                                        alert(MessageHash[378]);
                                        return false;
                                    }
                                }
                                if(!oForm.down('input[name="repo_label"]').value){
                                    alert(MessageHash[349]);
                                    return false;
                                }
                                var userSelection = ajaxplorer.getUserSelection();
                                var publicUrl = ajxpServerAccessPath+'&get_action=share&sub_action=delegate_repo';
                                publicUrl = userSelection.updateFormOrUrl(null,publicUrl);
                                var conn = new Connexion(publicUrl);
                                conn.setParameters(modal.getForm().serialize(true));
                                conn.onComplete = function(transport){
                                    var response = parseInt(transport.responseText);
                                    if(response == 200){
                                        ajaxplorer.displayMessage('SUCCESS', MessageHash[348]);
                                        ajaxplorer.fireContextRefresh();
                                        hideLightBox(true);
                                    }else{
                                        messages = {100:349, 101:352, 102:350, 103:351};
                                        ajaxplorer.displayMessage('ERROR', MessageHash[messages[response]]);
                                    }
                                };
                                conn.sendAsync();
                                return false;
                            };
                            if(window.ajxpBootstrap.parameters.get("usersEditable") == false){
                                ajaxplorer.displayMessage('ERROR', MessageHash[394]);
                            }else{
                                modal.showDialogForm('Get', 'share_folder_form', loadFunc, submitFunc, null);
                            }
                        }else{

                            if(!window.ajxpPublicUrlCallback){
                                window.ajxpPublicUrlCallback = function(){
                                    var userSelection = ajaxplorer.getUserSelection();
                                    if(!userSelection.isUnique() || (userSelection.hasDir() && !userSelection.hasMime($A(['ajxp_browsable_archive'])))) return;
                                    var publicUrl = ajxpServerAccessPath+'&get_action=share';
                                    publicUrl = userSelection.updateFormOrUrl(null,publicUrl);
                                    var oForm = $(modal.getForm());
                                    var conn = new Connexion(publicUrl);
                                    conn.setParameters(oForm.serialize(true));
                                    conn.addParameter('get_action','share');
                                    conn.onComplete = function(transport){
                                        var cont = oForm.down('input[id="share_container"]');
                                        if(cont){
                                            cont.value = transport.responseText;
                                            cont.select();
                                        }
                                        var email = oForm.down('a[id="email"]');
                                        if (email){
                                            email.setAttribute('href', 'mailto:unknown@unknown.com?Subject=UPLOAD&Body='+transport.responseText);
                                        }
                                        new Effect.Fade(oForm.down('fieldset[id="share_generate"]'), {
                                            duration:0.5,
                                            afterFinish : function(){
                                                modal.refreshDialogAppearance();
                                                new Effect.Appear(oForm.down('fieldset[id="share_result"]'), {
                                                    duration:0.5,
                                                    afterFinish : function(){
                                                        cont.select();
                                                        modal.refreshDialogAppearance();
                                                        ajaxplorer.fireContextRefresh();
                                                    }
                                                });
                                            }
                                        });
                                    };
                                    conn.sendSync();
                                };
                            }
                            var loadFunc = function(oForm){
                                new Protopass(oForm.down('input[name="password"]'), {
                                    barContainer : $('public_pass_container'),
                                    barPosition:'bottom',
                                    minchar : 0
                                });
                                var button = $(oForm).down('div.fakeUploadButton');
                                if(!button.listenerAttached){
                                    button.listenerAttached = true;
                                    button.observe("click", window.ajxpPublicUrlCallback);
                                }
                            };
                            modal.showDialogForm('Get', 'share_form', loadFunc, function(){
                                hideLightBox(true);
                                return false;
                            }, null, true);
                        }
                        ]]></clientCallback>
                        <clientForm id="share_form"><![CDATA[
                        <div id="share_form" title="AJXP_MESSAGE[293]"  box_width="280" action="share">
                            <fieldset>
                                <legend ajxp_message_id="307">AJXP_MESSAGE[307]</legend>
                                <div ajxp_message_id="294" class="dialogLegend">AJXP_MESSAGE[294]</div>
                                <div style="padding:10px 5px 0 5;">
                                    <span ajxp_message_id="295">AJXP_MESSAGE[295]</span>
                                    <input type="text" name="expiration" value="0" style="width: 20px ! important;margin-right:10px;">

                                    <span ajxp_message_id="182">AJXP_MESSAGE[182]</span>
                                    <input type="password" style="width:60px;" name="password" value="" autocomplete="off">
                                </div>
                                <div class="SF_element" id="public_pass_container"></div>
                            </fieldset>
                            <fieldset id="share_generate">
                                <legend ajxp_message_id="308">AJXP_MESSAGE[308]</legend>
                                <div align="center" style="color: #999; margin-top:5px; font-size:10px;">
                                    <div align="center" class="fakeUploadButton"><img src="AJXP_THEME_FOLDER/images/actions/22/share.png" height="22" width="22"/><br/>AJXP_MESSAGE[309]</div>
                                </div>
                            </fieldset>
                            <fieldset style="display:none;" id="share_result">
                                <legend ajxp_message_id="296">AJXP_MESSAGE[296]</legend>
                                <input type="text" style="width:200px;margin-right:5px;" id="share_container"/>
                                <a id="email" title="AJXP_MESSAGE[323]"><img style="border:none;" align="absmiddle" src="AJXP_THEME_FOLDER/images/actions/22/mail_generic.png" height="22" width="22"/></a>
                            </fieldset>
                        </div>
                        <div id="share_folder_form" title="Share Folder"  box_width="280" action="share">
                            <fieldset>
                                <legend ajxp_message_id="357">AJXP_MESSAGE[357]</legend>
                                <div class="dialogLegend" ajxp_message_id="358">AJXP_MESSAGE[358]</div>
                                <div class="SF_element">
                                    <div class="SF_label" ajxp_message_id="359">AJXP_MESSAGE[359] : </div>
                                    <input type="text" value="" id="repo_label" name="repo_label" class="SF_input"/>
                                </div>
                            </fieldset>
                            <fieldset>
                                <legend ajxp_message_id="353">AJXP_MESSAGE[353]</legend>
                                <div class="dialogLegend" ajxp_message_id="354">AJXP_MESSAGE[354]</div>
                                <div class="SF_element">
                                    <div class="SF_label" ajxp_message_id="360">AJXP_MESSAGE[360] : </div>
                                    <div class="SF_input">
                                        <select name="repo_rights" style="width:135px;">
                                            <option value="r">AJXP_MESSAGE[361]</option>
                                            <option value="rw"/>AJXP_MESSAGE[361] & AJXP_MESSAGE[362]</option>
                                            <option value="w">AJXP_MESSAGE[412]</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="SF_element">
                                    <div ajxp_message_id="355" class="SF_label">AJXP_MESSAGE[355] : </div>
                                    <input type="text" class="SF_input dialogFocus" value="" name="shared_user" id="shared_user"/>
                                    <div id="shared_users_autocomplete_choices" class="autocomplete" style="margin-top:0px !important;"></div>
                                </div>
                                <div class="SF_element" id="shared_pass_div">
                                    <div class="SF_label" ajxp_message_id="356">AJXP_MESSAGE[356] : </div>
                                    <input type="password" autocomplete="off" value="" name="shared_pass" id="shared_pass" class="SF_input"/>
                                </div>
                                <div class="SF_element" id="pass_strength_container"></div>
                            </fieldset>
                        </div>
                        ]]>
                        </clientForm>
                    <serverCallback methodName="switchAction"></serverCallback>
                    </processing>
            </action>
        </actions>
    </registry_contributions>
    <class_definition filename="plugins/action.share/class.ShareCenter.php" classname="ShareCenter"/>
    <dependencies>
        <activePlugin pluginName="access.AJXP_STREAM_PROVIDER"/>
    </dependencies>
</action_plugin>