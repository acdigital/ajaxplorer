<?xml version="1.0" encoding="UTF-8"?>
<ajxp_plugin id="action.scheduler" label="CONF_MESSAGE[Tasks Scheduler]" description="CONF_MESSAGE[Register tasks to be run on a regular basis instead of writing them one by one in cron tab.]"  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="file:../core.ajaxplorer/ajxp_registry.xsd">
    <client_settings>
        <resources>
            <i18n namespace="action.scheduler" path="plugins/action.scheduler/i18n"/>
        </resources>
    </client_settings>
    <registry_contributions>
        <actions>
            <action name="run_scheduler">
                <processing>
                    <clientCallback prepareModal="true"><![CDATA[
                        var connexion = new Connexion();
                        connexion.setParameters(new Hash({get_action:'run_scheduler'}));
                        connexion.sendAsync();
                    ]]></clientCallback>
                    <serverCallback methodName="switchAction"/>
                    </processing>
            </action>
            <action name="ls">
                <pre_processing>
                    <serverCallback methodName="listTasks" applyCondition="$apply=($httpVars['dir']=='/admin/scheduler');"/>
                </pre_processing>
                <post_processing>
                    <serverCallback methodName="switchAction" applyCondition="$apply=($httpVars['dir']=='/admin');" capture="true"/>
                </post_processing>
            </action>
            <action name="scheduler_addTask">
                <gui text="292" title="292" src="share.png" hasAccessKey="false">
                    <context selection="false" dir="" recycle="hidden"
                             actionBar="true" contextMenu="true" infoPanel="true"
                             actionBarGroup="put">
                    </context>
                </gui>
                <processing>
                    <clientCallback prepareModal="true" dialogOpenForm="scheduler-task-form" dialogOkButtonOnly="false" dialogSkipButtons="false">
                       <dialogOnOpen><![CDATA[
                           this.currentFormManager = new FormManager();
                           var xmlDefinition = ajaxplorer.getXmlRegistry();
                           var node = XPathSelectSingleNode(xmlDefinition, 'actions/action[@name="scheduler_addTask"]/processing/standardFormDefinition');

                           this.currentFormManager.params = this.currentFormManager.parseParameters(node, "param");
                           this.currentFormManager.createParametersInputs(
                                $('scheduler-task-form'),
                                this.currentFormManager.params,
                                true
                           );
                       ]]></dialogOnOpen>
                        <dialogOnComplete><![CDATA[
                            var values = new Hash({});
                           this.currentFormManager.serializeParametersInputs(
                                $('scheduler-task-form'),
                                values,
                                '');
                                console.log(values);
                       ]]></dialogOnComplete>
                    </clientCallback>
                    <clientForm id="scheduler-task-form"><![CDATA[
                        <div id="scheduler-task-form" box_width="300"></div>
                    ]]></clientForm>
                    <standardFormDefinition>
                        <param name="schedule" group="Task execution" label="action.scheduler.2" description="action.scheduler.2d" type="string" mandatory="true"/>
                        <param name="repository_id" group="Task execution" label="action.scheduler.4" description="action.scheduler.4d" type="string" mandatory="true"/>
                        <param name="action" group="Parameters" label="action.scheduler.1" description="action.scheduler.1d" type="string" mandatory="true"/>
                        <param name="param_name" group="Parameters" replicationGroup="group1" label="action.scheduler.6" description="action.scheduler.6d" type="string" mandatory="false"/>
                        <param name="param_value" group="Parameters" replicationGroup="group1" label="action.scheduler.7" description="action.scheduler.7d" type="string" mandatory="false"/>
                    </standardFormDefinition>
                    <serverCallback methodName="handleTasks"/>
                </processing>
            </action>
        </actions>
    </registry_contributions>
    <class_definition filename="plugins/action.scheduler/class.AjxpScheduler.php" classname="AjxpScheduler"/>
    <dependencies>
        <activePlugin pluginName="access.ajxp_conf"/>
    </dependencies>
</ajxp_plugin>